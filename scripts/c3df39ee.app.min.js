"use strict";angular.module("PalSzak.Hexwar",["ngAnimate","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$locationProvider","$routeProvider",function(a,b){a.html5Mode(!1),b.when("/",{templateUrl:"views/home.html"}).when("/game",{templateUrl:"views/game.html"}).when("/about",{templateUrl:"views/about.html"}).otherwise({redirectTo:"/"})}]),angular.module("PalSzak.Hexwar").constant("version","v0.1.0").constant("state").constant("sizes",[{name:"hex_size_xs",size:20},{name:"hex_size_sm",size:25},{name:"hex_size_md",size:35},{name:"hex_size_lg",size:50}]).constant("neighbourName",[[["bottomRight","bottom","bottomLeft"],["topRight","IMPOSIBLE","topLeft"],["IMPOSIBLE","top","IMPOSIBLE"]],[["IMPOSIBLE","bottom","IMPOSIBLE"],["bottomRight","IMPOSIBLE","bottomLeft"],["topRight","top","topLeft"]]]).constant("neighbours",[[[1,0],[-1,1],[0,-1],[-1,-1],[-1,0],[0,1]],[[1,1],[1,0],[0,-1],[-1,0],[1,-1],[0,1]]]),angular.module("PalSzak.Hexwar").constant("maps",[{name:"map3",maxPlayerLabel:"3 players map",maxPlayer:3},{name:"map4",maxPlayerLabel:"4 players map",maxPlayer:4},{name:"map2small",maxPlayerLabel:"2 players map",maxPlayer:2},{name:"map2",maxPlayerLabel:"2 players map",maxPlayer:2}]),angular.module("PalSzak.Hexwar").constant("map2",{0:{0:{population:2,owner:"empty"},1:{population:2,owner:"empty"},2:{population:2,owner:"empty"},3:{population:10,owner:"player1"},4:{population:2,owner:"empty"},5:{population:2,owner:"empty"},6:{population:2,owner:"empty"}},1:{0:{population:2,owner:"empty"},1:{population:2,owner:"natural"},2:{population:2,owner:"natural"},3:{population:2,owner:"natural"},4:{population:2,owner:"natural"},5:{population:2,owner:"natural"},6:{population:2,owner:"empty"}},2:{0:{population:2,owner:"natural"},1:{population:2,owner:"natural"},2:{population:2,owner:"natural"},3:{population:2,owner:"empty"},4:{population:2,owner:"natural"},5:{population:2,owner:"natural"},6:{population:2,owner:"natural"}},3:{0:{population:2,owner:"natural"},1:{population:2,owner:"natural"},2:{population:2,owner:"empty"},3:{population:2,owner:"empty"},4:{population:2,owner:"empty"},5:{population:2,owner:"natural"},6:{population:2,owner:"natural"}},4:{0:{population:2,owner:"natural"},1:{population:2,owner:"natural"},2:{population:2,owner:"empty"},3:{population:2,owner:"empty"},4:{population:2,owner:"empty"},5:{population:2,owner:"natural"},6:{population:2,owner:"natural"}},5:{0:{population:2,owner:"natural"},1:{population:2,owner:"natural"},2:{population:2,owner:"natural"},3:{population:2,owner:"natural"},4:{population:2,owner:"natural"},5:{population:2,owner:"natural"},6:{population:2,owner:"natural"}},6:{0:{population:2,owner:"empty"},1:{population:2,owner:"empty"},2:{population:2,owner:"natural"},3:{population:10,owner:"player2"},4:{population:2,owner:"natural"},5:{population:2,owner:"empty"},6:{population:2,owner:"empty"}}}),angular.module("PalSzak.Hexwar").constant("map2small",{0:{0:{population:10,owner:"player1"},1:{population:2,owner:"natural"},2:{population:2,owner:"player2"}}}),angular.module("PalSzak.Hexwar").constant("map3",{0:{0:{population:10,owner:"empty"},1:{population:10,owner:"natural"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"empty"},5:{population:10,owner:"empty"},6:{population:10,owner:"empty"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"natural"},10:{population:10,owner:"empty"}},1:{0:{population:10,owner:"natural"},1:{population:10,owner:"player1"},2:{population:10,owner:"natural"},3:{population:10,owner:"empty"},4:{population:10,owner:"empty"},5:{population:10,owner:"empty"},6:{population:10,owner:"empty"},7:{population:10,owner:"empty"},8:{population:10,owner:"natural"},9:{population:10,owner:"player2"},10:{population:10,owner:"natural"}},2:{0:{population:10,owner:"natural"},1:{population:10,owner:"natural"},2:{population:10,owner:"natural"},3:{population:10,owner:"natural"},4:{population:10,owner:"empty"},5:{population:10,owner:"natural"},6:{population:10,owner:"empty"},7:{population:10,owner:"natural"},8:{population:10,owner:"natural"},9:{population:10,owner:"natural"},10:{population:10,owner:"natural"}},3:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}},4:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}},5:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"empty"},5:{population:10,owner:"natural"},6:{population:10,owner:"empty"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}},6:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"empty"},5:{population:10,owner:"natural"},6:{population:10,owner:"empty"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}},7:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"player3"},6:{population:10,owner:"natural"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}},8:{0:{population:10,owner:"empty"},1:{population:10,owner:"empty"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"},7:{population:10,owner:"empty"},8:{population:10,owner:"empty"},9:{population:10,owner:"empty"},10:{population:10,owner:"empty"}}}),angular.module("PalSzak.Hexwar").constant("map4",{0:{0:{population:10,owner:"player1"},1:{population:10,owner:"player1"},2:{population:10,owner:"natural"},3:{population:10,owner:"natural"},4:{population:10,owner:"natural"},5:{population:10,owner:"player2"},6:{population:10,owner:"player2"}},1:{0:{population:10,owner:"player1"},1:{population:10,owner:"player1"},2:{population:10,owner:"empty"},3:{population:10,owner:"empty"},4:{population:10,owner:"empty"},5:{population:10,owner:"player2"},6:{population:10,owner:"player2"}},2:{0:{population:10,owner:"natural"},1:{population:10,owner:"natural"},2:{population:10,owner:"natural"},3:{population:10,owner:"natural"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"}},3:{0:{population:10,owner:"natural"},1:{population:10,owner:"natural"},2:{population:10,owner:"natural"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"}},4:{0:{population:10,owner:"natural"},1:{population:10,owner:"natural"},2:{population:10,owner:"natural"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"}},5:{0:{population:10,owner:"natural"},1:{population:10,owner:"natural"},2:{population:10,owner:"natural"},3:{population:10,owner:"natural"},4:{population:10,owner:"natural"},5:{population:10,owner:"natural"},6:{population:10,owner:"natural"}},6:{0:{population:10,owner:"natural"},1:{population:10,owner:"player4"},2:{population:10,owner:"natural"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"player3"},6:{population:10,owner:"natural"}},7:{0:{population:10,owner:"player4"},1:{population:10,owner:"player4"},2:{population:10,owner:"empty"},3:{population:10,owner:"natural"},4:{population:10,owner:"empty"},5:{population:10,owner:"player3"},6:{population:10,owner:"player3"}},8:{0:{population:10,owner:"player4"},1:{population:10,owner:"empty"},2:{population:10,owner:"natural"},3:{population:10,owner:"empty"},4:{population:10,owner:"natural"},5:{population:10,owner:"empty"},6:{population:10,owner:"player3"}}}),angular.module("PalSzak.Hexwar").controller("MenuController",["$scope","$location","$modal","ai",function(a,b,c){a.interruptGame=function(){"/game"===b.path()&&c.open({templateUrl:"views/partials/modal/interrupt.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close("close")},a.cancel=function(){b.dismiss("cancel")}}],size:"sm"})},a.openRules=function(){c.open({templateUrl:"views/partials/modal/rules.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close("close")}}],size:"lg"})},a.openAbout=function(){c.open({templateUrl:"views/partials/modal/about.html",controller:["$scope","$modalInstance",function(a,b){a.ok=function(){b.close("close")}}],size:"lg"})}}]),angular.module("PalSzak.Hexwar").controller("boardController",["$scope","sizes","boardService",function(a,b,c){function d(a){return 2*a+2.1*(c.getColumnCount()-1)*a*3/4}var e=2;a.size=b[e].name,a.width={width:d(b[e].size)+"px"},a.zoomIn=function(){e+=e+1<b.length?1:0,a.size=b[e].name,a.width={width:d(b[e].size)+"px"}},a.zoomOut=function(){e-=e-1>-1?1:0,a.size=b[e].name,a.width={width:d(b[e].size)+"px"}}}]),angular.module("PalSzak.Hexwar").controller("MoveController",["$scope","gameService","selectService","playerService",function(a,b,c,d){function e(a,b){return angular.isDefined(a)?b-a:b}a.isPlayer="player"===d.getPlayer().type,a.$on("selection-changed",function(){a.from=c.getSource(),a.to=c.getTarget(),angular.isDefined(a.from)&&angular.isDefined(a.to)?(a.max=a.from.population,a.percentMax=a.from.percentMax,angular.isDefined(a.from[c.getNameOfNeighbour()])?(a.moveCount=a.from[c.getNameOfNeighbour()],a.max+=a.moveCount):a.moveCount=angular.isDefined(a.from)?a.from.population:void 0,angular.isDefined(a.from[c.getNameOfNeighbour()+"_permanent"])?(a.movePercent=a.from[c.getNameOfNeighbour()+"_permanent"],a.percentMax+=a.movePercent):a.movePercent=void 0):(a.moveCount=void 0,a.movePercent=void 0)}),a.move=function(){a.from.population-=e(a.from[c.getNameOfNeighbour()],a.moveCount),a.from[c.getNameOfNeighbour()]=a.moveCount,angular.isDefined(a.movePercent)&&(a.from.percentMax-=e(a.from[c.getNameOfNeighbour()+"_permanent"],a.movePercent),a.from[c.getNameOfNeighbour()+"_permanent"]=a.movePercent,0===a.movePercent&&delete a.from[c.getNameOfNeighbour()+"_permanent"]),c.deselectAll()},a.$on("turn-changed",function(){a.isPlayer="player"===d.getPlayer().type}),a.turn=function(){b.nextTurn()}}]),angular.module("PalSzak.Hexwar").controller("NewGameController",["$scope","maps","gameService",function(a,b,c){a.maps=b,a.gameModel={},a.gameModel.map=b[0],a.newGame=function(){c.initGame(a.gameModel)}}]),angular.module("PalSzak.Hexwar").directive("hex",function(){return{restrict:"E",replace:"true",scope:{idx:"=idx"},templateUrl:"views/partials/game/hex.html",controller:["$scope","boardService","selectService","fieldHelper",function(a,b,c,d){a.field=b.getField(a.idx),"empty"!==a.field.owner&&(a.select=c.setClicked,a.$on("selection-changed",function(){a.marker=angular.equals(a.field,c.getTarget())?"neighbour":angular.equals(a.field,c.getSource())?"active":angular.isUndefined(c.getTarget())&&d.getNameOfNeighbour(c.getSource(),a.field)?"neighbour":""}))}]}}),angular.module("PalSzak.Hexwar").directive("hexrow",["boardService",function(a){return{restrict:"A",replace:"true",scope:!1,compile:function(b,c){b.addClass("hex-row");for(var d=a.getColumnCount(),e=0;d>e;e++){var f={r:parseInt(c.r),c:e};b.append(e%2?"<hex idx="+angular.toJson(f)+' class="even"></hex>':"<hex idx="+angular.toJson(f)+" ></hex>")}}}}]),angular.module("PalSzak.Hexwar").directive("hexfield",["boardService",function(a){return{restrict:"E",replace:"true",compile:function(b){b.append('<div id="zoom" class="btn-group"><label class="btn btn-primary btn-xs" ng-click=\'zoomOut()\'>-</label><label class="btn btn-primary btn-xs" ng-click=\'zoomIn()\'>+</label></div>');for(var c=a.getRowCount(),d=0;c>d;d++)b.append('<div hexrow r="'+d+'"></div>')}}}]),angular.module("PalSzak.Hexwar").service("selectService",["$rootScope","fieldHelper","playerService",function(a,b,c){var d,e,f;this.getNameOfNeighbour=function(){return f},this.getSource=function(){return d},this.getTarget=function(){return e},this.setClicked=function(g){var h=!1;f=b.getNameOfNeighbour(d,g),angular.equals(g,d)?(d=void 0,e=void 0,h=!0):angular.isDefined(d)&&f?(e=g,h=!0):"player"===c.getPlayer().type&&g.owner===c.getPlayer().id&&(d=g,e=void 0,h=!0),h&&a.$broadcast("selection-changed")},this.deselectAll=function(){this.setClicked(d)}}]),angular.module("PalSzak.Hexwar").service("boardService",["$injector",function(a){function b(a,b){c=a,d=Object.keys(c).length,e=Object.keys(c[0]).length;for(var f=0;d>f;f++)for(var g=0;e>g;g++){c[f][g].idx={r:f,c:g},c[f][g].percentMax=100;for(var h=1;h<=b.map.maxPlayer;h++)c[f][g].owner==="player"+h&&"none"===b[h].type&&(c[f][g].owner="natural")}}var c,d,e;this.getRowCount=function(){return d},this.getColumnCount=function(){return e};this.getField=function(a){return angular.isDefined(a)&&angular.isDefined(a.c)&&angular.isDefined(a.r)?c[a.r][a.c]:void 0};this.initGame=function(c){var d=a.get(c.map.name);b(angular.copy(d),c)},this.getFieldOf=function(a){for(var b=[],f=0;d>f;f++)for(var g=0;e>g;g++){var h=c[f][g];h.owner===a&&b.push(h)}return b},this.getStatistic=function(){for(var a={},b=0;d>b;b++)for(var f=0;e>f;f++){var g=c[b][f];angular.isDefined(a[g.owner])?a[g.owner]++:a[g.owner]=1}return a}}]),angular.module("PalSzak.Hexwar").service("playerService",function(){var a,b;this.getPlayers=function(){return a},this.getPlayer=function(){return a[b%a.length]},this.removePlayer=function(b){var c=a.indexOf(b);c>-1&&a.splice(c,1)},this.initGame=function(c){a=[],b=-1;for(var d=1;d<=c.map.maxPlayer;d++)"none"!==c[d].type&&(c[d].id="player"+d,a.push(c[d]))},this.nextTurn=function(){b++}}),angular.module("PalSzak.Hexwar").service("fieldHelper",["neighbours","neighbourName",function(a,b){this.getNameOfNeighbour=function(c,d){var e;return angular.isDefined(c)&&angular.isDefined(d)&&a[(c.idx.c+1)%2].forEach(function(a){var f={r:d.idx.r+a[0],c:d.idx.c+a[1]};angular.equals(c.idx,f)&&(e=b[(c.idx.c+1)%2][a[0]+1][a[1]+1])}),e},this.getNeighbour=function(a,c){var d,e=b[(a.idx.c+1)%2];a:for(var f=0;3>f;f++)for(var g=0;3>g;g++)if(e[f][g]===c){d={r:a.idx.r-(f-1),c:a.idx.c-(g-1)};break a}return d}}]),angular.module("PalSzak.Hexwar").service("gameService",["$rootScope","$modal","playerService","boardService","selectService","fieldHelper",function(a,b,c,d,e,f){function g(a,b,c){b.owner===a.id?b.population+=c:h(a,b,c)}function h(a,b,c){b.population-=c,b.population<0&&(b.population*=-1,b.owner=a.id)}function i(a){a.population++}function j(a){b.open({templateUrl:"views/partials/modal/end.html",controller:["$scope","$modalInstance","winner",function(a,b,c){a.winner=c,a.ok=function(){b.close("newGame")},a.cancel=function(){b.dismiss("cancel")}}],size:"lg",resolve:{winner:function(){return a}}})}var k=["bottomRight","bottom","bottomLeft","topRight","topLeft","top"],l=!1;this.initGame=function(a){c.initGame(a),d.initGame(a),m()};var m=this.nextTurn=function(){e.deselectAll();var b=c.getPlayer();angular.isDefined(b)&&d.getFieldOf(b.id).forEach(function(a){i(a),k.forEach(function(c){if(angular.isDefined(a[c])){var e=d.getField(f.getNeighbour(a,c));g(b,e,a[c]),delete a[c]}})});var h=d.getStatistic();c.getPlayers().forEach(function(a){angular.isUndefined(h[a.id])&&c.removePlayer(a)}),1!==c.getPlayers().length||l||(l=!0,j(c.getPlayers()[0])),c.nextTurn(),b=c.getPlayer(),d.getFieldOf(b.id).forEach(function(a){var b=0;k.forEach(function(c){if(angular.isDefined(a[c+"_permanent"])){var d=Math.floor(a[c+"_permanent"]/100*a.population);b+=d,a[c]=d}}),a.population-=b}),a.$broadcast("turn-changed")}}]),angular.module("PalSzak.Hexwar").service("ai",["$rootScope","$timeout","gameService","playerService",function(a,b,c,d){a.$on("turn-changed",function(){"ai"===d.getPlayer().type&&b(function(){c.nextTurn()},100)})}]);